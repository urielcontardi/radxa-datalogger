<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radxa Serial Logger</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--surface:#161b22;--border:#30363d;
  --text:#c9d1d9;--text-dim:#8b949e;--accent:#58a6ff;
  --green:#3fb950;--red:#f85149;--yellow:#d29922;
  --orange:#f0883e;
}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:var(--bg);color:var(--text)}
body{display:flex;flex-direction:column}

/* --- HEADER --- */
header{display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border)}
header h1{font-size:18px;font-weight:600;letter-spacing:.5px}
header h1 span{color:var(--accent)}
.header-right{display:flex;align-items:center;gap:16px}
.header-status{font-size:12px;color:var(--text-dim)}

/* --- TOP NAV --- */
.top-nav{display:flex;gap:2px}
.nav-btn{padding:6px 16px;border:1px solid var(--border);border-radius:6px;
  cursor:pointer;font-size:13px;color:var(--text-dim);background:var(--surface);
  transition:.15s;font-family:inherit}
.nav-btn:hover{color:var(--text);border-color:var(--text-dim)}
.nav-btn.active{color:var(--accent);border-color:var(--accent);font-weight:600}

/* --- PAGE VISIBILITY --- */
.page{display:none;flex-direction:column;flex:1;overflow:hidden}
.page.active{display:flex}

/* --- TABS --- */
.tabs{display:flex;gap:4px;padding:8px 20px 0;background:var(--surface);border-bottom:1px solid var(--border)}
.tab{padding:8px 18px;border:1px solid transparent;border-bottom:none;border-radius:8px 8px 0 0;
  cursor:pointer;font-size:13px;color:var(--text-dim);background:transparent;transition:.15s}
.tab:hover{color:var(--text);background:var(--bg)}
.tab.active{color:var(--text);background:var(--bg);border-color:var(--border);font-weight:600}
.tab .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;
  background:var(--red);vertical-align:middle}
.tab .dot.on{background:var(--green)}

/* --- CONTROLS --- */
.controls{display:flex;flex-wrap:wrap;align-items:center;gap:8px;
  padding:10px 20px;background:var(--surface);border-bottom:1px solid var(--border)}
.controls label{font-size:12px;color:var(--text-dim);display:flex;align-items:center;gap:4px}
.controls input[type="datetime-local"],.controls input[type="text"]{
  padding:5px 8px;border:1px solid var(--border);border-radius:6px;
  background:var(--bg);color:var(--text);font-size:12px}
.controls input[type="datetime-local"]{width:190px}
.controls input[type="text"]{width:160px}
.btn{padding:5px 14px;border:1px solid var(--border);border-radius:6px;
  background:var(--bg);color:var(--text);font-size:13px;cursor:pointer;transition:.15s;
  font-family:inherit}
.btn:hover{border-color:var(--accent);color:var(--accent)}
.btn.live{border-color:var(--green);color:var(--green);font-weight:600}
.btn.live.off{border-color:var(--border);color:var(--text-dim);font-weight:400}
.spacer{flex:1}

/* --- LOG OUTPUT --- */
.log-main{flex:1;overflow:hidden;display:flex;flex-direction:column;padding:0 12px 12px}
#log-wrap{flex:1;overflow-y:auto;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;margin-top:8px;position:relative}
#log-output{padding:6px 14px;font-family:'Cascadia Code','Fira Code','JetBrains Mono',
  'Source Code Pro',Consolas,monospace;font-size:13px;line-height:1.15;word-break:break-all}
#log-output .line{display:block;white-space:pre-wrap;padding:0;margin:0;min-height:0}
#log-output .ts{color:var(--text-dim);user-select:all}
#empty-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  color:var(--text-dim);font-size:14px;text-align:center}

/* --- FOOTER --- */
footer{display:flex;justify-content:space-between;align-items:center;
  padding:8px 20px;font-size:12px;color:var(--text-dim);
  background:var(--surface);border-top:1px solid var(--border)}

/* --- SCROLLBAR --- */
#log-wrap::-webkit-scrollbar,.flash-console::-webkit-scrollbar{width:8px}
#log-wrap::-webkit-scrollbar-track,.flash-console::-webkit-scrollbar-track{background:var(--bg)}
#log-wrap::-webkit-scrollbar-thumb,.flash-console::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
#log-wrap::-webkit-scrollbar-thumb:hover,.flash-console::-webkit-scrollbar-thumb:hover{background:var(--text-dim)}

/* --- LOADING --- */
.spinner{display:none;width:18px;height:18px;border:2px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner.show{display:inline-block}

/* ============ FLASHER PAGE ============ */
.flash-page{padding:20px;overflow-y:auto;flex:1}
.flash-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:1100px;margin:0 auto}

.flash-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px}
.flash-card h2{font-size:15px;font-weight:600;margin-bottom:16px;color:var(--accent);
  display:flex;align-items:center;gap:8px}
.flash-card h2 .icon{font-size:18px}

/* --- Port cards --- */
.probe-list{display:flex;flex-direction:column;gap:8px}
.probe-item{display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--bg);
  cursor:pointer;transition:.15s}
.probe-item:hover{border-color:var(--accent)}
.probe-item.selected{border-color:var(--accent);background:rgba(88,166,255,0.08)}
.probe-item.flashing{border-color:var(--orange);background:rgba(240,136,62,0.08)}
.probe-info{display:flex;flex-direction:column;gap:2px}
.probe-name{font-size:13px;font-weight:600}
.probe-detail{font-size:11px;color:var(--text-dim)}
.probe-status{display:flex;align-items:center;gap:6px;font-size:11px}
.probe-dot{width:8px;height:8px;border-radius:50%;background:var(--red)}
.probe-dot.on{background:var(--green)}
.probe-dot.flash{background:var(--orange);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* --- File upload --- */
.file-drop{border:2px dashed var(--border);border-radius:8px;padding:24px;text-align:center;
  cursor:pointer;transition:.15s;position:relative;margin-bottom:12px}
.file-drop:hover{border-color:var(--accent);background:rgba(88,166,255,0.04)}
.file-drop.has-file{border-color:var(--green);border-style:solid;background:rgba(63,185,80,0.06)}
.file-drop input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-drop .drop-icon{font-size:28px;margin-bottom:8px;color:var(--text-dim)}
.file-drop .drop-text{font-size:13px;color:var(--text-dim)}
.file-drop .drop-filename{font-size:13px;color:var(--green);font-weight:600;margin-top:4px}

/* --- Form elements --- */
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:4px;font-weight:500}
.form-input{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:6px;
  background:var(--bg);color:var(--text);font-size:13px;font-family:inherit}
.form-input:focus{outline:none;border-color:var(--accent)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* --- Advanced toggle --- */
.advanced-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-dim);
  cursor:pointer;margin-bottom:12px;border:none;background:none;font-family:inherit;padding:0}
.advanced-toggle:hover{color:var(--text)}
.advanced-content{display:none;margin-bottom:12px}
.advanced-content.open{display:block}

/* --- Flash button --- */
.flash-btn{width:100%;padding:10px;border:1px solid var(--green);border-radius:8px;
  background:rgba(63,185,80,0.1);color:var(--green);font-size:14px;font-weight:600;
  cursor:pointer;transition:.15s;font-family:inherit;display:flex;align-items:center;
  justify-content:center;gap:8px}
.flash-btn:hover{background:rgba(63,185,80,0.2)}
.flash-btn:disabled{opacity:.4;cursor:not-allowed}
.flash-btn.running{border-color:var(--orange);color:var(--orange);background:rgba(240,136,62,0.1)}

.flash-all-btn{width:100%;padding:8px;border:1px solid var(--accent);border-radius:8px;
  background:rgba(88,166,255,0.08);color:var(--accent);font-size:13px;font-weight:500;
  cursor:pointer;transition:.15s;font-family:inherit;margin-top:8px}
.flash-all-btn:hover{background:rgba(88,166,255,0.16)}
.flash-all-btn:disabled{opacity:.4;cursor:not-allowed}

/* --- Console --- */
.flash-console{background:var(--bg);border:1px solid var(--border);border-radius:8px;
  padding:12px;font-family:'Cascadia Code','Fira Code','JetBrains Mono',Consolas,monospace;
  font-size:12px;line-height:1.5;max-height:400px;overflow-y:auto;white-space:pre-wrap;
  color:var(--text-dim)}
.flash-console .cmd{color:var(--accent)}
.flash-console .ok{color:var(--green)}
.flash-console .err{color:var(--red)}
.flash-console .warn{color:var(--yellow)}
.flash-console .info{color:var(--text)}

/* --- Pack list --- */
.pack-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.pack-tag{font-size:11px;padding:3px 8px;border:1px solid var(--border);border-radius:4px;
  background:var(--bg);color:var(--text-dim)}

@media(max-width:768px){
  .flash-grid{grid-template-columns:1fr}
  .form-row{grid-template-columns:1fr}
}
@media(max-width:640px){
  .controls{padding:8px 12px;gap:6px}
  header{padding:10px 12px}
  .tabs{padding:6px 12px 0}
  #log-output{font-size:11px;padding:4px 10px}
  .controls input[type="datetime-local"]{width:160px}
  .flash-page{padding:12px}
}
</style>
</head>
<body>

<header>
  <h1><span>&#9638;</span> Radxa Serial Logger</h1>
  <div class="header-right">
    <div class="top-nav">
      <button class="nav-btn active" data-page="logger" onclick="switchPage('logger')">Logger</button>
      <button class="nav-btn" data-page="flasher" onclick="switchPage('flasher')">Flasher</button>
    </div>
    <span class="header-status" id="header-status">Procurando dispositivos...</span>
  </div>
</header>

<!-- ============ LOGGER PAGE ============ -->
<div id="page-logger" class="page active">

<div class="tabs" id="port-tabs"></div>

<div class="controls">
  <label>De: <input type="datetime-local" id="dt-from" step="1"></label>
  <label>Ate: <input type="datetime-local" id="dt-to" step="1"></label>
  <button class="btn" id="btn-load" title="Carregar logs do periodo">Carregar</button>
  <div class="spacer"></div>
  <input type="text" id="search-input" placeholder="Buscar no log...">
  <button class="btn" id="btn-search">Buscar</button>
  <button class="btn live" id="btn-live">&#9679; Ao Vivo</button>
  <button class="btn" id="btn-download" title="Baixar log exibido">&#8681; Baixar</button>
  <div class="spinner" id="spinner"></div>
</div>

<div class="log-main">
  <div id="log-wrap">
    <div id="log-output"></div>
    <div id="empty-msg">Nenhum dispositivo DAP encontrado.<br>Conecte os dispositivos e aguarde...</div>
  </div>
</div>

<footer>
  <span id="footer-left">Aguardando...</span>
  <span id="footer-right">0 linhas</span>
</footer>

</div>

<!-- ============ FLASHER PAGE ============ -->
<div id="page-flasher" class="page">
<div class="flash-page">
<div class="flash-grid">

  <!-- Left column: Port selection + Console -->
  <div style="display:flex;flex-direction:column;gap:16px">
    <div class="flash-card">
      <h2><span class="icon">&#9881;</span> Dispositivos DAP</h2>
      <div class="probe-list" id="flash-probe-list">
        <div style="color:var(--text-dim);font-size:13px">Procurando dispositivos...</div>
      </div>
    </div>
    <div class="flash-card" style="flex:1">
      <h2><span class="icon">&#9638;</span> Console</h2>
      <div class="flash-console" id="flash-console">Pronto para gravar firmware.</div>
    </div>
  </div>

  <!-- Right column: Upload + Config + Buttons -->
  <div style="display:flex;flex-direction:column;gap:16px">
    <div class="flash-card">
      <h2><span class="icon">&#8682;</span> Firmware</h2>

      <div class="form-group">
        <label>Arquivo .hex / .bin / .s37</label>
        <div class="file-drop" id="hex-drop">
          <input type="file" id="hex-file-input" accept=".hex,.bin,.s37,.srec">
          <div class="drop-icon">&#128196;</div>
          <div class="drop-text">Arraste ou clique para selecionar</div>
          <div class="drop-filename" id="hex-filename"></div>
        </div>
      </div>

      <button class="advanced-toggle" id="adv-toggle" onclick="toggleAdvanced()">
        &#9654; Opcoes avancadas
      </button>
      <div class="advanced-content" id="adv-content">
        <div class="form-row">
          <div class="form-group">
            <label>Target</label>
            <input class="form-input" type="text" id="flash-target" value="EFR32FG28B322F1024IM48">
          </div>
          <div class="form-group">
            <label>Frequencia</label>
            <input class="form-input" type="text" id="flash-freq" value="20M">
          </div>
        </div>
        <div class="form-group">
          <label>Pack file (.pack) - opcional</label>
          <div class="file-drop" id="pack-drop" style="padding:14px">
            <input type="file" id="pack-file-input" accept=".pack">
            <div class="drop-text">Arraste .pack ou clique</div>
            <div class="drop-filename" id="pack-filename"></div>
          </div>
          <div id="pack-available" style="margin-top:6px"></div>
        </div>
      </div>

      <button class="flash-btn" id="btn-flash" onclick="flashSelected()" disabled>
        &#9889; Gravar Firmware
      </button>
      <button class="flash-all-btn" id="btn-flash-all" onclick="flashAll()" disabled>
        &#9889; Gravar em TODOS os dispositivos
      </button>
    </div>
  </div>

</div>
</div>

<footer>
  <span id="flash-footer-left">Selecione um dispositivo e um firmware</span>
  <span id="flash-footer-right"></span>
</footer>
</div>

<script>
/* ====== PAGE SWITCHING ====== */
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelector('.nav-btn[data-page="'+page+'"]').classList.add('active');
  if (page === 'flasher') refreshFlasherPorts();
}

/* ====== ANSI-to-HTML parser ====== */
const COLORS = ['#586069','#ff6b6b','#69db7c','#ffd43b','#74c0fc','#da77f2','#66d9e8','#ced4da'];
const BRIGHT  = ['#8b949e','#ff8787','#8ce99a','#ffe066','#a5d8ff','#e599f7','#99e9f2','#f8f9fa'];

function escHtml(ch) {
  if (ch === '&') return '&amp;';
  if (ch === '<') return '&lt;';
  if (ch === '>') return '&gt;';
  return ch;
}

function ansiToHtml(raw) {
  let result = '';
  let openSpans = 0;
  let i = 0;

  while (i < raw.length) {
    const code = raw.charCodeAt(i);

    if (code === 0x1b && i + 1 < raw.length && raw[i + 1] === '[') {
      let j = i + 2;
      let seq = '';
      while (j < raw.length && ((raw[j] >= '0' && raw[j] <= '9') || raw[j] === ';')) {
        seq += raw[j];
        j++;
      }
      if (j < raw.length && raw[j] === 'm') {
        j++;
        const codes = seq.split(';').filter(Boolean).map(Number);

        if (!codes.length || (codes.length === 1 && codes[0] === 0)) {
          while (openSpans > 0) { result += '</span>'; openSpans--; }
        } else {
          if (codes.includes(0)) {
            while (openSpans > 0) { result += '</span>'; openSpans--; }
          }
          let styles = [];
          for (const n of codes) {
            if (n === 0) continue;
            if (n === 1) styles.push('font-weight:bold');
            if (n === 2) styles.push('opacity:.7');
            if (n === 3) styles.push('font-style:italic');
            if (n === 4) styles.push('text-decoration:underline');
            if (n >= 30 && n <= 37) styles.push('color:' + COLORS[n - 30]);
            if (n >= 40 && n <= 47) styles.push('background:' + COLORS[n - 40]);
            if (n >= 90 && n <= 97) styles.push('color:' + BRIGHT[n - 90]);
            if (n >= 100 && n <= 107) styles.push('background:' + BRIGHT[n - 100]);
          }
          if (styles.length) {
            result += '<span style="' + styles.join(';') + '">';
            openSpans++;
          }
        }
        i = j;
        continue;
      }
      i++;
      continue;
    }

    if (code < 32 && code !== 9 && code !== 10) {
      i++;
      continue;
    }

    result += escHtml(raw[i]);
    i++;
  }

  while (openSpans > 0) { result += '</span>'; openSpans--; }
  return result;
}

/* ====== Format a single log line ====== */
const TS_RE = /^\[(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3})\]\s?/;

function formatLine(text) {
  const m = text.match(TS_RE);
  if (m) {
    const ts = m[1].replace('T',' ');
    const rest = text.substring(m[0].length);
    const stripped = rest.replace(/\x1b\[[0-9;]*m/g, '').trim();
    if (!stripped) return '';
    return '<span class="line"><span class="ts">[' + ts + ']</span> ' + ansiToHtml(rest) + '</span>';
  }
  const stripped = text.replace(/\x1b\[[0-9;]*m/g, '').trim();
  if (!stripped) return '';
  return '<span class="line">' + ansiToHtml(text) + '</span>';
}

/* ================================================================
   LOGGER PAGE
   ================================================================ */

let ports = [];
let activePort = null;
let liveMode = true;
let ws = null;
let autoScroll = true;
let lineCount = 0;
const MAX_DOM_LINES = 8000;

const $tabs      = document.getElementById('port-tabs');
const $logWrap   = document.getElementById('log-wrap');
const $logOut    = document.getElementById('log-output');
const $empty     = document.getElementById('empty-msg');
const $btnLive   = document.getElementById('btn-live');
const $btnLoad   = document.getElementById('btn-load');
const $btnSearch = document.getElementById('btn-search');
const $btnDL     = document.getElementById('btn-download');
const $dtFrom    = document.getElementById('dt-from');
const $dtTo      = document.getElementById('dt-to');
const $search    = document.getElementById('search-input');
const $spinner   = document.getElementById('spinner');
const $hStatus   = document.getElementById('header-status');
const $fLeft     = document.getElementById('footer-left');
const $fRight    = document.getElementById('footer-right');

$logWrap.addEventListener('scroll', () => {
  const { scrollHeight, scrollTop, clientHeight } = $logWrap;
  autoScroll = (scrollHeight - scrollTop - clientHeight) < 60;
});

function scrollBottom() {
  if (autoScroll) $logWrap.scrollTop = $logWrap.scrollHeight;
}

function clearLog() {
  $logOut.innerHTML = '';
  lineCount = 0;
  $fRight.textContent = '0 linhas';
}

function appendHtml(html, count) {
  $logOut.insertAdjacentHTML('beforeend', html);
  lineCount += count;
  while ($logOut.childNodes.length > MAX_DOM_LINES) {
    $logOut.removeChild($logOut.firstChild);
    lineCount--;
  }
  $fRight.textContent = lineCount + ' linhas';
  scrollBottom();
}

function setLoading(on) { $spinner.classList.toggle('show', on); }

function renderTabs() {
  $tabs.innerHTML = '';
  ports.forEach((p, i) => {
    const t = document.createElement('div');
    t.className = 'tab' + (p.id === activePort ? ' active' : '');
    t.innerHTML = '<span class="dot ' + (p.connected ? 'on' : '') + '"></span>' +
                  p.name + ' <small style="color:var(--text-dim)">(' + p.device + ')</small>';
    t.onclick = () => selectPort(p.id);
    $tabs.appendChild(t);
  });
}

async function fetchPorts() {
  try {
    const r = await fetch('/api/ports');
    ports = await r.json();
    if (ports.length) {
      $empty.style.display = 'none';
      const connected = ports.filter(p => p.connected).length;
      $hStatus.textContent = connected + '/' + ports.length + ' conectado(s)';
      if (!activePort) selectPort(ports[0].id);
      else renderTabs();
    } else {
      $empty.style.display = '';
      $hStatus.textContent = 'Procurando dispositivos...';
    }
  } catch { /* retry next interval */ }
}

function selectPort(id) {
  activePort = id;
  renderTabs();
  clearLog();
  const p = ports.find(x => x.id === id);
  $fLeft.textContent = p ? p.device : id;
  if (liveMode) startLive(); else loadHistory();
}

function startLive() {
  stopWs();
  if (!activePort) return;
  clearLog();
  setLoading(true);

  fetch('/api/logs/' + activePort + '/tail?lines=500')
    .then(r => r.json())
    .then(data => {
      setLoading(false);
      if (data.lines && data.lines.length) {
        const html = data.lines.map(formatLine).filter(Boolean).join('');
        appendHtml(html, data.lines.length);
      }
      connectWs();
    })
    .catch(() => { setLoading(false); connectWs(); });
}

function connectWs() {
  if (!activePort) return;
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/api/ws/' + activePort);
  ws.onmessage = (e) => {
    const html = formatLine(e.data);
    if (html) appendHtml(html, 1);
  };
  ws.onclose = () => { if (liveMode && activePort) setTimeout(connectWs, 3000); };
  ws.onerror = () => { try { ws.close(); } catch {} };
}

function stopWs() {
  if (ws) { try { ws.close(); } catch {} ws = null; }
}

async function loadHistory() {
  if (!activePort) return;
  stopWs();
  clearLog();
  setLoading(true);

  const params = new URLSearchParams();
  if ($dtFrom.value) params.set('datetime_from', $dtFrom.value);
  if ($dtTo.value)   params.set('datetime_to',   $dtTo.value);
  if ($search.value) params.set('search',         $search.value);
  params.set('limit', '10000');

  try {
    const r = await fetch('/api/logs/' + activePort + '?' + params);
    const data = await r.json();
    setLoading(false);
    if (data.lines && data.lines.length) {
      const html = data.lines.map(formatLine).filter(Boolean).join('');
      appendHtml(html, data.lines.length);
      if (data.has_more) $fLeft.textContent += ' (truncado em 10000 linhas)';
    } else {
      $logOut.innerHTML = '<span style="color:var(--text-dim)">Nenhum registro encontrado para o periodo.</span>';
    }
  } catch (e) {
    setLoading(false);
    $logOut.innerHTML = '<span style="color:var(--red)">Erro ao carregar logs.</span>';
  }
}

$btnLive.addEventListener('click', () => {
  liveMode = !liveMode;
  $btnLive.classList.toggle('off', !liveMode);
  $btnLive.innerHTML = liveMode ? '&#9679; Ao Vivo' : '&#9675; Historico';
  if (liveMode) startLive(); else { stopWs(); }
});

$btnLoad.addEventListener('click', () => {
  liveMode = false;
  $btnLive.classList.add('off');
  $btnLive.innerHTML = '&#9675; Historico';
  loadHistory();
});

$btnSearch.addEventListener('click', () => {
  liveMode = false;
  $btnLive.classList.add('off');
  $btnLive.innerHTML = '&#9675; Historico';
  loadHistory();
});

$search.addEventListener('keydown', (e) => { if (e.key === 'Enter') $btnSearch.click(); });

$btnDL.addEventListener('click', () => {
  const text = $logOut.innerText;
  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (activePort || 'log') + '_' + new Date().toISOString().slice(0,10) + '.txt';
  a.click();
  URL.revokeObjectURL(a.href);
});

/* ================================================================
   FLASHER PAGE
   ================================================================ */

let flashPorts = [];
let selectedFlashPort = null;
let hexFile = null;
let packFile = null;
let flashConfig = { target: 'EFR32FG28B322F1024IM48', frequency: '20M', packs: [] };
let isFlashing = false;

const $probeList   = document.getElementById('flash-probe-list');
const $console     = document.getElementById('flash-console');
const $hexInput    = document.getElementById('hex-file-input');
const $hexName     = document.getElementById('hex-filename');
const $hexDrop     = document.getElementById('hex-drop');
const $packInput   = document.getElementById('pack-file-input');
const $packName    = document.getElementById('pack-filename');
const $packDrop    = document.getElementById('pack-drop');
const $packAvail   = document.getElementById('pack-available');
const $btnFlash    = document.getElementById('btn-flash');
const $btnFlashAll = document.getElementById('btn-flash-all');
const $flashTarget = document.getElementById('flash-target');
const $flashFreq   = document.getElementById('flash-freq');
const $flashFLeft  = document.getElementById('flash-footer-left');
const $flashFRight = document.getElementById('flash-footer-right');

function toggleAdvanced() {
  const content = document.getElementById('adv-content');
  const toggle = document.getElementById('adv-toggle');
  const open = content.classList.toggle('open');
  toggle.innerHTML = (open ? '&#9660;' : '&#9654;') + ' Opcoes avancadas';
}

$hexInput.addEventListener('change', (e) => {
  hexFile = e.target.files[0] || null;
  $hexName.textContent = hexFile ? hexFile.name : '';
  $hexDrop.classList.toggle('has-file', !!hexFile);
  updateFlashButtons();
});

$packInput.addEventListener('change', (e) => {
  packFile = e.target.files[0] || null;
  $packName.textContent = packFile ? packFile.name : '';
  $packDrop.classList.toggle('has-file', !!packFile);
});

function updateFlashButtons() {
  const canFlash = hexFile && !isFlashing;
  $btnFlash.disabled = !(canFlash && selectedFlashPort);
  $btnFlashAll.disabled = !(canFlash && flashPorts.length > 0);
}

function renderFlashProbes() {
  if (!flashPorts.length) {
    $probeList.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:8px 0">Nenhum dispositivo DAP encontrado.</div>';
    return;
  }
  $probeList.innerHTML = '';
  flashPorts.forEach(p => {
    const div = document.createElement('div');
    const isSelected = p.id === selectedFlashPort;
    const isFlashingThis = p.flashing;
    div.className = 'probe-item' + (isSelected ? ' selected' : '') + (isFlashingThis ? ' flashing' : '');
    div.innerHTML =
      '<div class="probe-info">' +
        '<div class="probe-name">' + escHtmlStr(p.name) + '</div>' +
        '<div class="probe-detail">' + escHtmlStr(p.device) + '</div>' +
        '<div class="probe-detail">SN: ' + escHtmlStr(p.serial_number || 'N/A') + '</div>' +
      '</div>' +
      '<div class="probe-status">' +
        '<span class="probe-dot ' + (isFlashingThis ? 'flash' : (p.connected ? 'on' : '')) + '"></span>' +
        '<span>' + (isFlashingThis ? 'Gravando...' : (p.connected ? 'Conectado' : 'Desconectado')) + '</span>' +
      '</div>';
    div.onclick = () => {
      if (isFlashing) return;
      selectedFlashPort = p.id;
      renderFlashProbes();
      updateFlashButtons();
    };
    $probeList.appendChild(div);
  });
}

function escHtmlStr(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function refreshFlasherPorts() {
  try {
    const [portsRes, configRes] = await Promise.all([
      fetch('/api/ports'),
      fetch('/api/flasher/config'),
    ]);
    flashPorts = await portsRes.json();
    flashConfig = await configRes.json();

    $flashTarget.value = flashConfig.target || 'EFR32FG28B322F1024IM48';
    $flashFreq.value = flashConfig.frequency || '20M';

    if (flashConfig.packs && flashConfig.packs.length) {
      $packAvail.innerHTML = '<div style="font-size:11px;color:var(--text-dim)">Packs no servidor:</div>' +
        '<div class="pack-list">' +
        flashConfig.packs.map(p => '<span class="pack-tag">' + escHtmlStr(p) + '</span>').join('') +
        '</div>';
    } else {
      $packAvail.innerHTML = '<div style="font-size:11px;color:var(--text-dim)">Nenhum .pack no servidor. Faca upload ou copie para /app/packs.</div>';
    }

    renderFlashProbes();
    updateFlashButtons();
  } catch {}
}

function consoleLog(text, cls) {
  const span = document.createElement('span');
  span.className = cls || 'info';
  span.textContent = text + '\n';
  $console.appendChild(span);
  $console.scrollTop = $console.scrollHeight;
}

function consoleClear() {
  $console.innerHTML = '';
}

async function doFlash(portId, portName) {
  const formData = new FormData();
  formData.append('hex_file', hexFile);

  const target = $flashTarget.value.trim();
  const freq = $flashFreq.value.trim();
  if (target) formData.append('target', target);
  if (freq) formData.append('frequency', freq);

  consoleLog('--- Gravando ' + portName + ' (' + portId + ') ---', 'warn');
  consoleLog('Arquivo: ' + hexFile.name, 'info');
  consoleLog('Aguarde...', 'info');

  $flashFLeft.textContent = 'Gravando ' + portName + '...';

  try {
    const r = await fetch('/api/flasher/flash/' + portId, {
      method: 'POST',
      body: formData,
    });
    const data = await r.json();

    if (data.command) consoleLog('$ ' + data.command, 'cmd');
    if (data.output) consoleLog(data.output.trim(), 'info');
    if (data.error) consoleLog(data.error.trim(), data.success ? 'warn' : 'err');

    if (data.success) {
      consoleLog('OK - Firmware gravado com sucesso!', 'ok');
    } else {
      consoleLog('ERRO - Falha na gravacao.', 'err');
    }

    return data.success;
  } catch (e) {
    consoleLog('ERRO: ' + e.message, 'err');
    return false;
  }
}

async function flashSelected() {
  if (!selectedFlashPort || !hexFile || isFlashing) return;

  isFlashing = true;
  const port = flashPorts.find(p => p.id === selectedFlashPort);
  const portName = port ? port.name : selectedFlashPort;

  $btnFlash.classList.add('running');
  $btnFlash.innerHTML = '&#8987; Gravando...';
  updateFlashButtons();
  consoleClear();

  await doFlash(selectedFlashPort, portName);

  isFlashing = false;
  $btnFlash.classList.remove('running');
  $btnFlash.innerHTML = '&#9889; Gravar Firmware';
  $flashFLeft.textContent = 'Gravacao finalizada';
  updateFlashButtons();
  refreshFlasherPorts();
}

async function flashAll() {
  if (!hexFile || isFlashing || !flashPorts.length) return;

  isFlashing = true;
  $btnFlashAll.disabled = true;
  $btnFlash.disabled = true;
  $btnFlashAll.textContent = 'Gravando...';
  consoleClear();

  let ok = 0;
  let fail = 0;
  for (const port of flashPorts) {
    consoleLog('', 'info');
    const success = await doFlash(port.id, port.name);
    if (success) ok++; else fail++;
    await refreshFlasherPorts();
  }

  consoleLog('', 'info');
  consoleLog('========================================', 'info');
  consoleLog('Resultado: ' + ok + ' OK, ' + fail + ' falha(s) de ' + flashPorts.length + ' dispositivos', ok === flashPorts.length ? 'ok' : 'warn');

  isFlashing = false;
  $btnFlashAll.textContent = '\u26A1 Gravar em TODOS os dispositivos';
  $flashFLeft.textContent = 'Gravacao em lote finalizada: ' + ok + '/' + flashPorts.length;
  updateFlashButtons();
}

/* ================================================================
   INIT
   ================================================================ */
const now = new Date();
const todayStr = now.toISOString().slice(0, 10);
$dtTo.value = todayStr + 'T23:59:59';

fetchPorts();
setInterval(fetchPorts, 5000);
setInterval(() => {
  if (document.getElementById('page-flasher').classList.contains('active')) {
    refreshFlasherPorts();
  }
}, 5000);
</script>
</body>
</html>
